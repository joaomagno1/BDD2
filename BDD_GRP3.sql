DROP TABLE BD2_Answers;
DROP TABLE BD2_Badges;

DROP TABLE BD2_UserProgress;
DROP TABLE BD2_Questions;

DROP TABLE BD2_Submodules;
DROP TABLE BD2_Modules;

DROP TABLE BD2_Users;
DROP TABLE BD2_Disciplines;

CREATE TABLE BD2_Users (
    USER_ID                 NUMBER GENERATED BY DEFAULT AS IDENTITY(START WITH 3) PRIMARY KEY,
    USERNAME                VARCHAR2(50) NOT NULL UNIQUE,
    EMAIL                   VARCHAR2(100) NOT NULL UNIQUE,
    PASSWORD_HASH           VARCHAR2(255) NOT NULL,
    CREATED_AT              TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    FAILED_LOGIN_ATTEMPTS   NUMBER DEFAULT 0 NOT NULL
);

CREATE TABLE BD2_Disciplines (
    DISCIPLINE_ID   NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 3) PRIMARY KEY,
    NAME            VARCHAR2(100) NOT NULL,
    DESCRIPTION     VARCHAR2(500),
    CREATED_AT      TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

CREATE TABLE BD2_Modules (
    MODULE_ID       NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 4) PRIMARY KEY,
    DISCIPLINE_ID   NUMBER NOT NULL,
    TITLE           VARCHAR2(100) NOT NULL,
    DESCRIPTION     VARCHAR2(500),
    SORT_ORDER      NUMBER DEFAULT 0 NOT NULL,
    
    CONSTRAINT fk_bd2_modules_discipline FOREIGN KEY (DISCIPLINE_ID) REFERENCES BD2_Disciplines(DISCIPLINE_ID)
);

CREATE TABLE BD2_Submodules (
    SUBMODULE_ID    NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 3) PRIMARY KEY,
    MODULE_ID       NUMBER NOT NULL,
    TITLE           VARCHAR2(100) NOT NULL,
    EXPLANATION     CLOB,
    SORT_ORDER      NUMBER DEFAULT 0 NOT NULL,
    
    CONSTRAINT fk_bd2_submodules_module FOREIGN KEY (MODULE_ID) REFERENCES BD2_Modules(MODULE_ID)
);

CREATE TABLE BD2_Questions (
    QUESTION_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 3) PRIMARY KEY,
    SUBMODULE_ID    NUMBER NOT NULL,
    QUESTION_TEXT   VARCHAR2(1000) NOT NULL,
    OPTIONS         VARCHAR2(2000) CHECK (OPTIONS IS JSON),
    CORRECT_ANSWER  CHAR(1) NOT NULL,
    
    CONSTRAINT fk_bd2_questions_submodule FOREIGN KEY (SUBMODULE_ID) REFERENCES BD2_Submodules(SUBMODULE_ID)
);

CREATE TABLE BD2_UserProgress (
    PROGRESS_ID     NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 3) PRIMARY KEY,
    USER_ID         NUMBER NOT NULL,
    SUBMODULE_ID    NUMBER NOT NULL,
    QUIZ_SCORE      NUMBER DEFAULT 0 NOT NULL CHECK (QUIZ_SCORE BETWEEN 0 AND 5),
    LAST_VIEWED     TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    STRENGTH        NUMBER DEFAULT 1 NOT NULL CHECK (STRENGTH BETWEEN 1 AND 5),
    
    CONSTRAINT uq_bd2_user_submodule_progress UNIQUE (USER_ID, SUBMODULE_ID),
    CONSTRAINT fk_bd2_progress_user FOREIGN KEY (USER_ID) REFERENCES BD2_Users(USER_ID),
    CONSTRAINT fk_bd2_progress_submodule FOREIGN KEY (SUBMODULE_ID) REFERENCES BD2_Submodules(SUBMODULE_ID)
);

CREATE TABLE BD2_Answers (
    ANSWER_ID       NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 3) PRIMARY KEY,
    PROGRESS_ID     NUMBER NOT NULL,
    QUESTION_ID     NUMBER NOT NULL,
    USER_ANSWER     CHAR(1),
    IS_CORRECT      NUMBER(1,0) NOT NULL CHECK (IS_CORRECT IN (0, 1)),
    ATTEMPT_NUMBER  NUMBER DEFAULT 1 NOT NULL,
    
    CONSTRAINT fk_bd2_answers_progress FOREIGN KEY (PROGRESS_ID) REFERENCES BD2_UserProgress(PROGRESS_ID),
    CONSTRAINT fk_bd2_answers_question FOREIGN KEY (QUESTION_ID) REFERENCES BD2_Questions(QUESTION_ID)
);

CREATE TABLE BD2_Badges (
    BADGE_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 2) PRIMARY KEY,
    USER_ID         NUMBER NOT NULL,
    SUBMODULE_ID    NUMBER NOT NULL,
    NAME            VARCHAR2(100) NOT NULL,
    AWARDED_AT      TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    CONSTRAINT fk_bd2_badges_user FOREIGN KEY (USER_ID) REFERENCES BD2_Users(USER_ID),
    CONSTRAINT fk_bd2_badges_submodule FOREIGN KEY (SUBMODULE_ID) REFERENCES BD2_Submodules(SUBMODULE_ID)
);
