create or replace TRIGGER TRG_CALC_MEDIA
INSTEAD OF INSERT OR UPDATE OR DELETE ON V_ALUNO_AVALIACAO
FOR EACH ROW
DECLARE
    V_ID_ALUNO ALUNO.ID_ALUNO%TYPE;
    V_ID_AVALIACAO AVALIACAO.ID_AVALIACAO%TYPE;
    V_ID_DISCIPLINA DISCIPLINA.ID_DISCIPLINA%TYPE;
    V_MEDIA MATRICULA.MEDIA%TYPE;
BEGIN
    IF INSERTING THEN
        INSERT INTO ALUNO_AVALIACAO (ID_ALUNO_AVALIACAO, NOTA,
        ID_ALUNO, ID_AVALIACAO)
        VALUES (:NEW.ID_ALUNO_AVALIACAO, :NEW.NOTA,
        :NEW.ID_ALUNO, :NEW.ID_AVALIACAO);

        V_ID_ALUNO := :NEW.ID_ALUNO;
        V_ID_AVALIACAO := :NEW.ID_AVALIACAO;

        ELSIF UPDATING THEN
            UPDATE ALUNO_AVALIACAO
            SET NOTA = :NEW.NOTA
            WHERE ID_ALUNO_AVALIACAO = :OLD.ID_ALUNO_AVALIACAO;

            V_ID_ALUNO := :OLD.ID_ALUNO;
            V_ID_AVALIACAO := :OLD.ID_AVALIACAO;

        ELSIF DELETING THEN
            DELETE ALUNO_AVALIACAO
            WHERE ID_ALUNO_AVALIACAO = :OLD.ID_ALUNO_AVALIACAO;

            V_ID_ALUNO := :OLD.ID_ALUNO;
            V_ID_AVALIACAO := :OLD.ID_AVALIACAO;
    END IF;

    SELECT ID_DISCIPLINA 
    INTO V_ID_DISCIPLINA
    FROM AVALIACAO
    WHERE ID_AVALIACAO = V_ID_AVALIACAO;

    SELECT AVG(AA.NOTA)
    INTO V_MEDIA
    FROM ALUNO_AVALIACAO AA
    JOIN AVALIACAO AV ON AA.ID_AVALIACAO = AV.ID_AVALIACAO
    WHERE AA.ID_AVALIACAO = V_ID_ALUNO AND
    AV.ID_DISCIPLINA = V_ID_DISCIPLINA;

    UPDATE MATRICULA
    SET MEDIA = NVL(V_MEDIA, 0)
    WHERE ID_ALUNO = V_ID_ALUNO AND
        ID_DISCIPLINA = V_ID_DISCIPLINA;
END TRG_CALC_MEDIA;
