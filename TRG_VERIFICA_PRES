create or replace TRIGGER TRG_VERIFICA_PRES
BEFORE INSERT OR UPDATE OF PID_RECEBIDO ON AMIGOSECRETO
FOR EACH ROW
DECLARE
    V_COUNT NUMBER;
    V_AMIGO_RECEBE NUMBER;
BEGIN
    IF :NEW.PID_RECEBIDO IS NULL THEN
        RETURN;
    END IF;

    V_AMIGO_RECEBE := :NEW.AID_AMIGO;

    SELECT COUNT (*)
    INTO V_COUNT
    FROM LISTAPRESENTE
    WHERE AID = V_AMIGO_RECEBE
        AND PID = :NEW.PID_RECEBIDO;

    IF V_COUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20011, 'ERRO: O presente: ' || :NEW.PID_RECEBIDO || ' não está na lista de desejos do amigo: ' || V_AMIGO_RECEBE || '.');
    END IF;
END;    
